name: Build + Update reccmp Report

on:
  pull_request:
    branches:
      - main
  push:
    branches:
      - main

concurrency:
  group: ${{ github.head_ref || github.ref_name }}
  cancel-in-progress: true

permissions:
  contents: write
  pull-requests: write

jobs:
  fetch-deps:
    name: Download original binary
    uses: ./.github/workflows/cmr2bin.yml

  build:
    name: Build (MSVC 6.0)
    needs: [fetch-deps]
    runs-on: "windows-latest"

    steps:
      - uses: actions/checkout@main
        with:
          submodules: recursive

      - name: Fetch MSVC 6.0
        uses: actions/checkout@main
        with:
          repository: itsmattkc/msvc600
          path: msvc600

      - name: Build
        shell: cmd
        run: |
          mkdir build
          call .\msvc600\VC98\bin\VCVARS32.BAT x86
          call .\msvc600\VC98\bin\cl.exe .\CMR2Decomp\*.cpp /Fe"build/CMR2.exe" /O2 /DNDEBUG /Zi /Gz /MD /link user32.lib gdi32.lib /DEBUG /PDB:"build\CMR2.pdb" /SUBSYSTEM:WINDOWS

      - name: Upload Build
        uses: actions/upload-artifact@main
        with:
          name: Win32
          path: |
            build/CMR2.exe
            build/CMR2.pdb

  verify:
    name: Verify decomp
    needs: [build, fetch-deps]
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@main
        with:
          ref: ${{ github.head_ref }}

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - uses: actions/download-artifact@main
        with:
          name: Win32
          path: build

      - name: Restore cached original binary
        id: cache-original-binary
        uses: actions/cache/restore@v4
        with:
          enableCrossOsArchive: true
          path: cmr2bin
          key: cmr2bin

      - name: Install reccmp
        shell: bash
        run: |
          pip install git+https://github.com/isledecomp/reccmp

      - name: Detect binary
        run: |
          reccmp-project detect --what original   --search-path cmr2bin
          reccmp-project detect --what recompiled --search-path build

      - name: Compare Accuracy to main
        if: github.ref != 'refs/heads/main' # Only runs on pull requests
        shell: bash
        env:
          RELEASE_URL: https://raw.githubusercontent.com/CMR2Decomp/CMR2Decomp/refs/heads/main/CMR2PROGRESS/
        run: |
          # Download the current main state
          curl -fLSs -o summary-old.json $RELEASE_URL/summary.json || echo "" >summary-old.json

          # Compare with current main
          reccmp-reccmp --target CMR2 --html index.html --json CMR2PROGRESS/summary.json --diff summary-old.json || echo "Current master not found"

      - name: Test Exports
        shell: bash
        run: |
          reccmp-verexp --target CMR2

      # Don't have any vtables yet
      # - name: Check Vtables
      #   shell: bash
      #   run: |
      #     reccmp-vtable --target CMR2

      - name: Check Variables
        shell: bash
        run: |
          reccmp-datacmp --target CMR2

      - name: Upsert PR Accuracy Report
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            const TAG = '<!-- CMR2-ACCURACY-REPORT -->';
            const STUB_THRESHOLD = 0.001;

            function load(path) {
              if (!fs.existsSync(path)) {
                console.log("file doesnt exist.");
                return null;
              }
              return JSON.parse(fs.readFileSync(path, 'utf8'));
            }

            const currentRaw = load('CMR2PROGRESS/summary.json');
            if (!currentRaw) {
              core.setFailed('summary.json not found');
              return;
            }

            const previousRaw = load('summary-old.json');

            const current = currentRaw?.data || [];
            const previous = previousRaw?.data || [];

            if (!current.length) {
              console.log('No functions found in summary.json, skipping PR comment.');
              return;
            }

            const currMap = new Map();
            current.forEach(fn => currMap.set(fn.address, fn));

            const prevMap = new Map();
            if (previous) {
              previous.forEach(fn => prevMap.set(fn.address, fn));
            }

            const increased = [];
            const decreased = [];
            const added = [];
            const gone = [];
            const stubbed = [];

            let total = 0;
            let matched = 0;
            let aligned = 0;

            for (const fn of current) {
              total++;
              matched += fn.matching;

              if (!fn.diff || fn.diff.length === 0) aligned++;

              const prev = prevMap.get(fn.address);

              if (!prev) {
                added.push(fn);
                if (fn.matching <= STUB_THRESHOLD) {
                  stubbed.push({ fn, reason: 'new stub' });
                }
                continue;
              }

              const prevPct = prev.matching * 100;
              const currPct = fn.matching * 100;

              if (currPct > prevPct + 0.01) {
                increased.push({ fn, prevPct, currPct });
              } else if (currPct < prevPct - 0.01) {
                decreased.push({ fn, prevPct, currPct });
              }

              if (prev.matching > STUB_THRESHOLD && fn.matching <= STUB_THRESHOLD) {
                stubbed.push({ fn, reason: 'regressed to stub' });
              }
            }

            for (const [addr, fn] of prevMap) {
              if (!currMap.has(addr)) {
                gone.push(fn);
              }
            }

            const effective = ((matched / total) * 100).toFixed(2);
            const alignedPct = ((aligned / total) * 100).toFixed(2);

            function deltaTable(rows) {
              if (!rows.length) return '_None_';
              return [
                '| Address | Function | Before | After |',
                '|--------:|----------|--------|-------|',
                ...rows.map(r =>
                  `| \`${r.fn.address}\` | ${r.fn.name} | ${r.prevPct.toFixed(2)}% | **${r.currPct.toFixed(2)}%** |`
                )
              ].join('\n');
            }

            function simpleTable(rows) {
              if (!rows.length) return '_None_';
              return [
                '| Address | Function | Accuracy |',
                '|--------:|----------|----------|',
                ...rows.map(
                  f => `| \`${f.address}\` | ${f.name} | ${(f.matching * 100).toFixed(2)}% |`
                )
              ].join('\n');
            }

            const goneTable = gone.length
              ? [
                  '| Address | Function | Previous Accuracy |',
                  '|--------:|----------|-------------------|',
                  ...gone.map(
                    f => `| \`${f.address}\` | ${f.name} | ${(f.matching * 100).toFixed(2)}% |`
                  )
                ].join('\n')
              : '_None_';

            const stubTable = stubbed.length
              ? [
                  '| Address | Function | Reason |',
                  '|--------:|----------|--------|',
                  ...stubbed.map(
                    s => `| \`${s.fn.address}\` | ${s.fn.name} | ${s.reason} |`
                  )
                ].join('\n')
              : '_None_';

            const body = [
              TAG,
              '',
              '## ðŸ“Š CMR2 Accuracy Report',
              '',
              `**Functions:** ${total}  `,
              `**Effective Accuracy:** **${effective}%**  `,
              `**Aligned:** ${aligned} (${alignedPct}%)`,
              '',
              '---',
              '',
              '### âœ… Increased',
              deltaTable(increased),
              '',
              '---',
              '',
              '### âš ï¸ Decreased',
              deltaTable(decreased),
              '',
              '---',
              '',
              '### âž• Added',
              simpleTable(added),
              '',
              '---',
              '',
              '### ðŸ§± Stubbed',
              stubTable,
              '',
              '---',
              '',
              '### âŒ Gone',
              goneTable,
              '',
              '_Last updated by CMR2Decomp Bot_'
            ].join('\n');

            const { owner, repo } = context.repo;
            const issue_number = context.issue.number;

            const comments = await github.paginate(
              github.rest.issues.listComments,
              { owner, repo, issue_number }
            );

            const existing = comments.find(c => c.body.includes(TAG));

            if (existing) {
              await github.rest.issues.updateComment({
                owner,
                repo,
                comment_id: existing.id,
                body
              });
            } else {
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number,
                body
              });
            }

      - name: Commit Accuracy Reports
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        shell: bash
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          git add index.html CMR2PROGRESS/summary.json

          if git diff --cached --quiet; then
            echo "No accuracy report changes to commit"
            exit 0
          fi

          git commit -m "chore: update accuracy reports [skip ci]"
          git push
